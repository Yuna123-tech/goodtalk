<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ê¸€ë§˜ ì±Œë¦°ì§€: ìš°ë¦¬ë°˜ í–‰ë³µ ë³´ë“œê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Dongle:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f9ff; /* ë§¤ìš° ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
        }
        .font-dongle {
            font-family: 'Dongle', sans-serif;
        }
        /* ê²Œì„ ë³´ë“œ ìŠ¤íƒ€ì¼ */
        .game-board {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 800px;
            height: 550px;
            position: relative;
        }
        .board-space {
            border: 2px solid #60a5fa; /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1e3a8a;
            background-color: #dbeafe; /* ì—°í•œ íŒŒë€ìƒ‰ */
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .board-space:hover {
            transform: scale(1.05);
        }
        /* ë³´ë“œ ê²½ë¡œ ì„¤ì • */
        .path { background-color: #bfdbfe; }
        .start { background-color: #4ade80; color: white; font-size: 1.2rem; } /* ì´ˆë¡ìƒ‰ ì‹œì‘ */
        .finish { background-color: #f87171; color: white; font-size: 1.2rem; } /* ë¹¨ê°„ìƒ‰ ë„ì°© */
        .mal-card { border-color: #facc15; background-color: #fef9c3; } /* ë…¸ë€ìƒ‰ 'ë§' ì¹´ë“œ */
        .geul-card { border-color: #34d399; background-color: #d1fae5; } /* ì´ˆë¡ìƒ‰ 'ê¸€' ì¹´ë“œ */
        .mam-card { border-color: #fb923c; background-color: #ffedd5; } /* ì£¼í™©ìƒ‰ 'ë§˜' ì¹´ë“œ */
        
        /* í”Œë ˆì´ì–´ ë§ ìŠ¤íƒ€ì¼ (í¬ê¸° ì¡°ì •) */
        .player-piece {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.5s ease-in-out;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 10px solid;
        }
        #drawing-canvas {
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: crosshair;
        }

        /* ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(180deg) scale(1.2); }
            50% { transform: rotate(360deg) scale(1); }
            75% { transform: rotate(540deg) scale(1.2); }
            100% { transform: rotate(720deg) scale(1); }
        }
        .rolling {
            animation: roll 0.7s ease-in-out;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <audio id="bgm" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-5xl md:text-6xl font-bold text-blue-600 font-dongle">ë§ê¸€ë§˜ ì±Œë¦°ì§€</h1>
            <p class="text-lg text-gray-600 mt-2">ìš°ë¦¬ë°˜ í–‰ë³µì„ ë§Œë“œëŠ” ë””ì§€í„¸ ë³´ë“œê²Œì„</p>
        </header>

        <div id="start-screen" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold text-blue-500 mb-4">ì–´ë–»ê²Œ í”Œë ˆì´í• ê¹Œìš”?</h2>
            <div class="flex justify-center gap-6 mb-6">
                <label class="flex items-center gap-2 p-3 border-2 border-blue-500 rounded-lg cursor-pointer">
                    <input type="radio" name="game-mode" value="team" checked class="w-5 h-5">
                    <span class="font-bold text-lg">ëª¨ë‘  ëŒ€í•­ì „</span>
                </label>
                <label class="flex items-center gap-2 p-3 border-2 border-gray-300 rounded-lg cursor-pointer">
                    <input type="radio" name="game-mode" value="individual" class="w-5 h-5">
                    <span class="font-bold text-lg">ê°œì¸ì „</span>
                </label>
            </div>
            <div class="mb-4">
                <label for="participant-count" id="participant-label" class="font-bold text-lg">ëª¨ë‘  ìˆ˜ ì„ íƒ (2~12ê°œ):</label>
                <input type="number" id="participant-count" value="4" min="2" max="12" class="ml-2 w-20 p-2 border rounded-lg text-center">
            </div>
            <button id="start-game-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">
                ì±Œë¦°ì§€ ì‹œì‘!
            </button>
        </div>

        <main id="game-container" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-grow flex justify-center items-center">
                    <div id="game-board" class="game-board"></div>
                </div>
                <div class="lg:w-1/4 bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-4 text-blue-800">ê²Œì„ í˜„í™©</h2>
                    <div id="turn-indicator" class="text-center mb-4 p-3 rounded-lg text-white font-bold text-lg"></div>
                    <div id="team-scores" class="space-y-2 mb-6"></div>
                    <div class="text-center">
                        <div id="dice-container" class="w-24 h-24 mx-auto mb-4 bg-white border-4 border-gray-300 rounded-2xl flex items-center justify-center text-5xl font-bold shadow-inner">
                            <span id="dice-face">ğŸ²</span>
                        </div>
                        <button id="roll-dice-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105 w-full">
                            ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°
                        </button>
                        <button id="home-btn" class="mt-4 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full text-md w-full">
                            ì²˜ìŒìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ê°¤ëŸ¬ë¦¬ ì˜ì—­ì€ ì´ì œ ìˆ¨ê²¨ì ¸ì„œ JS ë°ì´í„° ì €ì¥ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤ -->
            <div id="gallery-storage" class="hidden">
                <div id="gallery"></div>
            </div>
        </main>
    </div>

    <!-- ë¯¸ì…˜ ëª¨ë‹¬ -->
    <div id="mission-modal" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content">
            <h2 id="modal-title" class="text-4xl font-bold mb-4 font-dongle">ë¯¸ì…˜ ì¹´ë“œ</h2>
            <div id="modal-body" class="text-lg"></div>
            <div class="mt-6">
                <button id="fail-mission-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full mr-2">
                    ë¯¸ì…˜ ì‹¤íŒ¨
                </button>
                <button id="close-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">
                    ë¯¸ì…˜ ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="final-modal" class="modal-backdrop hidden">
        <div class="modal-content border-yellow-400">
             <h2 class="text-4xl font-bold mb-4 text-yellow-500 font-dongle">ğŸ‰ ì±Œë¦°ì§€ ì™„ë£Œ! ğŸ‰</h2>
             <p class="text-lg mb-4">ìš°ë¦¬ë°˜ ëª¨ë‘ì˜ í˜ìœ¼ë¡œ í–‰ë³µ ì—ë„ˆì§€ë¥¼ ê°€ë“ ì±„ì› ì–´ìš”!<br>ì•„ë˜ì—ì„œ ìš°ë¦¬ê°€ ë§Œë“  ì†Œì¤‘í•œ ì‘í’ˆë“¤ì„ ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.</p>
             <div id="final-slideshow" class="bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
             <p class="mt-4 text-sm text-gray-600">â€» ì´ ì‘í’ˆë“¤ì„ ëª¨ì•„ 'ë§ê¸€ë§˜ ìº í˜ì¸ì†¡'ì— ë§ì¶°<br>ë©‹ì§„ 'ìš°ë¦¬ë°˜ ë§ê¸€ë§˜ ì˜ìƒ'ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”!</p>
             <button onclick="location.reload()" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">
                ë‹¤ì‹œí•˜ê¸°
            </button>
        </div>
    </div>

    <!-- NEW: ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirm-home-modal" class="modal-backdrop hidden">
        <div class="modal-content border-red-400">
             <h2 class="text-3xl font-bold mb-4 text-red-500">ì •ë§ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”?</h2>
             <p class="text-lg mb-6">ì§€ê¸ˆê¹Œì§€ ì§„í–‰í•œ ë‚´ìš©ì€ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
             <div class="flex justify-center gap-4">
                 <button id="cancel-home-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-8 rounded-full">
                    ì·¨ì†Œ
                </button>
                <button id="confirm-home-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-full">
                    ëŒì•„ê°€ê¸°
                </button>
             </div>
        </div>
    </div>

    <script>
        // ê²Œì„ ì„¤ì • ë° ìƒíƒœ ë³€ìˆ˜
        const boardSpaces = 24;
        const boardPath = [1, 2, 3, 4, 5, 6, 13, 12, 11, 10, 9, 8, 15, 16, 17, 18, 19, 20, 27, 26, 25, 24, 23, 22];
        const teamColors = ['#ef4444', '#3b82f6', '#22c55e', '#f97316', '#8b5cf6', '#ec4899', '#10b981', '#64748b', '#f59e0b', '#06b6d4', '#d946ef', '#65a30d'];
        
        let gameState = {
            teams: [],
            currentTurn: 0,
            gameActive: false,
            gameMode: 'team', // 'team' or 'individual'
        };

        const missions = [
            { type: 'ë§', content: "ì¹œêµ¬ì—ê²Œ ë“¤ì—ˆë˜ ë§ ì¤‘ì— ê°€ì¥ ê¸°ë¶„ ì¢‹ì•˜ë˜ ë§ì„ ë°œí‘œí•´ ë³´ì„¸ìš”." },
            { type: 'ê¸€', content: "í•™êµì—ì„œ ì°¾ì„ ìˆ˜ ìˆëŠ” 'ì¢‹ì€ ê¸€ê·€'ë¥¼ ì‚¬ì§„ ì°ê³ , ì™œ ì¢‹ì€ì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ ì ì–´ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'ê³ ë§ˆì›Œ!' í•˜ëŠ” ë§ˆìŒì„ ë‹´ì€ ì´ëª¨í‹°ì½˜ì„ ê·¸ë ¤ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "ë‚´ê°€ ì¹œêµ¬ì—ê²Œ ë¬´ì‹¬ì½” í–ˆë˜ ë§ ì¤‘ í›„íšŒë˜ëŠ” ê²ƒì´ ìˆë‹¤ë©´? ì•ìœ¼ë¡œ ì–´ë–»ê²Œ ë§í•  ê±´ì§€ ë‹¤ì§ì„ ë°œí‘œí•´ìš”." },
            { type: 'ë§˜', content: "'í˜ë‚´!'ë¼ê³  ì‘ì›í•˜ëŠ” í‘œì •ì˜ ìºë¦­í„°ë¥¼ ê·¸ë ¤ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ê¸€', content: "ìš°ë¦¬ ë°˜ ì¹œêµ¬ì˜ ì›ƒëŠ” ëª¨ìŠµì„ ì‚¬ì§„ ì°ê³ , 'ì›ƒìŒì€ ìµœê³ ì˜ í–‰ë³µ!' ê°™ì€ ë©‹ì§„ í‘œì–´ë¥¼ ë¶™ì—¬ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "'ë§ê¸€ë§˜ ìº í˜ì¸ì†¡' ê°€ì‚¬ ì¤‘ ê°€ì¥ ë§ˆìŒì— ë“œëŠ” ë¶€ë¶„ì„ ê³¨ë¼ ê·¸ ì´ìœ ë¥¼ ì„¤ëª…í•´ ë³´ì„¸ìš”." },
            { type: 'ê¸€', content: "ìš°ë¦¬ êµì‹¤ì—ì„œ ê°€ì¥ ë”°ëœ»í•¨ì´ ëŠê»´ì§€ëŠ” ê³µê°„ì„ ì‚¬ì§„ ì°ê³ , ê·¸ ì´ìœ ë¥¼ ì ì–´ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'ë¯¸ì•ˆí•´'ë¼ëŠ” ë§ˆìŒì„ í‘œí˜„í•˜ëŠ” ì´ëª¨í‹°ì½˜ì„ ê·¸ë ¤ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "ì¹œêµ¬ê°€ ìŠ¬í¼ ë³´ì¼ ë•Œ ì–´ë–¤ ë§ì„ í•´ì£¼ë©´ ì¢‹ì„ì§€ ì—­í• ê·¹ìœ¼ë¡œ ë³´ì—¬ì£¼ì„¸ìš”." },
            { type: 'ê¸€', content: "ì„œë¡œ ë•ëŠ” ì¹œêµ¬ë“¤ì˜ ëª¨ìŠµì„ ì‚¬ì§„ìœ¼ë¡œ ì°ê³ , 'í•¨ê»˜í•˜ë©´ ë” ê°•í•´ì ¸!' ë¼ëŠ” ë¬¸êµ¬ë¥¼ ë„£ì–´ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'ìµœê³ ì•¼!'ë¼ê³  ì¹­ì°¬í•˜ëŠ” ë™ì‘ì˜ ìºë¦­í„°ë¥¼ ê·¸ë ¤ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "ê°€ì¡±ì—ê²Œ ê°€ì¥ í˜ì´ ë˜ì—ˆë˜ ë§ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”? ê²½í—˜ì„ ì´ì•¼ê¸°í•´ ë´…ì‹œë‹¤." },
            { type: 'ë§˜', content: "'ê°™ì´ ë†€ì!'ê³  ë§í•˜ëŠ” í‘œì •ì˜ ì´ëª¨í‹°ì½˜ì„ ê·¸ë ¤ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ê¸€', content: "í™œì§ í•€ ê½ƒ ì‚¬ì§„ì„ ì°ê³ , 'ë„ˆì˜ ë§ˆìŒë„ í™œì§'ì´ë¼ëŠ” ê¸€ì„ ì¨ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "ì¸í„°ë„·ì—ì„œ ë‚˜ìœ ë§ì„ ë´¤ì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì²˜í•´ì•¼ í• ì§€ ì´ì•¼ê¸°í•´ ë³´ì„¸ìš”." },
            { type: 'ê¸€', content: "ì§ˆì„œìˆê²Œ ì¤„ì„ ì„  ëª¨ìŠµì„ ì‚¬ì§„ ì°ê³ , 'ì§ˆì„œëŠ” ì•„ë¦„ë‹¤ì›Œ'ë¼ëŠ” í‘œì–´ë¥¼ ë¶™ì—¬ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'ì¶•í•˜í•´!' ê¸°ë»í•˜ëŠ” ë§ˆìŒì„ ë‹´ì€ ì´ëª¨í‹°ì½˜ì„ ê·¸ë ¤ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "ì¹­ì°¬ì€ ì™œ ì¤‘ìš”í• ê¹Œìš”? ìš°ë¦¬ ëª¨ë‘ ì˜ ìƒê°ì„ ì •ë¦¬í•´ì„œ ë°œí‘œí•´ ë³´ì„¸ìš”." },
            { type: 'ê¸€', content: "ë§‘ì€ í•˜ëŠ˜ ì‚¬ì§„ì„ ì°ê³ , 'ì˜¤ëŠ˜ í•˜ë£¨ë„ ë§‘ìŒ!'ì´ë¼ëŠ” ê¸€ì„ ì¨ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'ê´œì°®ì•„'ë¼ê³  ìœ„ë¡œí•˜ëŠ” ë”°ëœ»í•œ í‘œì •ì˜ ìºë¦­í„°ë¥¼ ê·¸ë ¤ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§', content: "'ê³ ë§™ìŠµë‹ˆë‹¤', 'ë¯¸ì•ˆí•©ë‹ˆë‹¤', 'ì‚¬ë‘í•©ë‹ˆë‹¤'ë¥¼ ì–¸ì œ ì‚¬ìš©í•´ì•¼ í• ì§€ ì´ì•¼ê¸° ë‚˜ëˆ ìš”." },
            { type: 'ê¸€', content: "ì„ ìƒë‹˜ê»˜ ê°ì‚¬í•œ ë§ˆìŒì„ ë‹´ì•„ ì†ê¸€ì”¨ í¸ì§€ë¥¼ ì“°ê³ , ì‚¬ì§„ìœ¼ë¡œ ì°ì–´ ì œì¶œí•´ì£¼ì„¸ìš”." },
            { type: 'ë§˜', content: "'í–‰ë³µ'ì´ë¼ëŠ” ê°ì •ì„ ë‚˜ë§Œì˜ ìºë¦­í„°ë¡œ í‘œí˜„í•´ì„œ ì œì¶œí•´ì£¼ì„¸ìš”." },
        ];

        const domElements = {
            startScreen: document.getElementById('start-screen'),
            gameContainer: document.getElementById('game-container'),
            startGameBtn: document.getElementById('start-game-btn'),
            participantCountInput: document.getElementById('participant-count'),
            participantLabel: document.getElementById('participant-label'),
            gameModeRadios: document.querySelectorAll('input[name="game-mode"]'),
            gameBoard: document.getElementById('game-board'),
            turnIndicator: document.getElementById('turn-indicator'),
            teamScoresContainer: document.getElementById('team-scores'),
            diceFace: document.getElementById('dice-face'),
            rollDiceBtn: document.getElementById('roll-dice-btn'),
            modal: document.getElementById('mission-modal'),
            modalContent: document.getElementById('modal-content'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            failMissionBtn: document.getElementById('fail-mission-btn'),
            bgm: document.getElementById('bgm'),
            gallery: document.getElementById('gallery'),
            finalModal: document.getElementById('final-modal'),
            finalSlideshow: document.getElementById('final-slideshow'),
            // NEW: ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ëª¨ë‹¬ ìš”ì†Œ
            homeBtn: document.getElementById('home-btn'),
            confirmHomeModal: document.getElementById('confirm-home-modal'),
            cancelHomeBtn: document.getElementById('cancel-home-btn'),
            confirmHomeBtn: document.getElementById('confirm-home-btn'),
        };

        // NEW: ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        domElements.homeBtn.addEventListener('click', () => {
            domElements.confirmHomeModal.classList.remove('hidden');
        });
        domElements.cancelHomeBtn.addEventListener('click', () => {
            domElements.confirmHomeModal.classList.add('hidden');
        });
        domElements.confirmHomeBtn.addEventListener('click', () => {
            location.reload();
        });

        domElements.gameModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.querySelectorAll('input[name="game-mode"]').forEach(r => {
                    r.parentElement.classList.remove('border-blue-500');
                    r.parentElement.classList.add('border-gray-300');
                });
                e.target.parentElement.classList.add('border-blue-500');
                e.target.parentElement.classList.remove('border-gray-300');

                if (e.target.value === 'team') {
                    domElements.participantLabel.textContent = 'ëª¨ë‘  ìˆ˜ ì„ íƒ (2~12ê°œ):';
                    domElements.participantCountInput.max = '12';
                    domElements.participantCountInput.value = '4';
                } else {
                    domElements.participantLabel.textContent = 'í”Œë ˆì´ì–´ ìˆ˜ ì„ íƒ (2~12ëª…):';
                    domElements.participantCountInput.max = '12';
                    domElements.participantCountInput.value = '4';
                }
            });
        });

        domElements.startGameBtn.addEventListener('click', () => {
            gameState.gameMode = document.querySelector('input[name="game-mode"]:checked').value;
            const participantCount = parseInt(domElements.participantCountInput.value);
            const maxCount = parseInt(domElements.participantCountInput.max);
            
            if (participantCount >= 2 && participantCount <= maxCount) {
                initializeGame(participantCount);
                domElements.startScreen.classList.add('hidden');
                domElements.gameContainer.classList.remove('hidden');
                domElements.bgm.play().catch(e => console.log("BGM ìë™ ì¬ìƒ ì‹¤íŒ¨. ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤."));
            } else {
                alert(`ì°¸ê°€ì ìˆ˜ëŠ” 2ì—ì„œ ${maxCount} ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            }
        });

        function initializeGame(participantCount) {
            // NEW: Clear previous session data on new game start
            sessionStorage.removeItem('galleryItems'); 
            domElements.gallery.innerHTML = ''; // Clear visual gallery storage element

            gameState.teams = [];
            const namePrefix = gameState.gameMode === 'team' ? 'ëª¨ë‘ ' : 'í”Œë ˆì´ì–´';
            for (let i = 0; i < participantCount; i++) {
                gameState.teams.push({
                    id: i,
                    name: `${i + 1}${namePrefix}`,
                    position: 1, // Start at space 1
                    previousPosition: 1, // Start at space 1
                    color: teamColors[i],
                });
            }
            gameState.currentTurn = 0;
            gameState.gameActive = true;
            createBoard();
            createPlayerPieces();
            updateTeamScores();
            updateTurnIndicator();
        }

        function createBoard() {
            domElements.gameBoard.innerHTML = '';
            let boardGrid = Array(35).fill(null);
            
            boardPath.forEach((gridIndex, pathIndex) => {
                const mission = missions[pathIndex];
                let cardType = '';
                if (mission) {
                    if (mission.type === 'ë§') cardType = 'mal-card';
                    else if (mission.type === 'ê¸€') cardType = 'geul-card';
                    else if (mission.type === 'ë§˜') cardType = 'mam-card';
                }
                boardGrid[gridIndex] = `<div id="space-${pathIndex + 1}" class="board-space path ${cardType}"><span>${pathIndex + 1}</span></div>`;
            });
            boardGrid[boardPath[0]] = `<div id="space-1" class="board-space start"><span>ì‹œì‘</span></div>`;
            boardGrid[boardPath[boardPath.length - 1]] = `<div id="space-${boardPath.length}" class="board-space finish"><span>ë„ì°©</span></div>`;
            
            for (let i = 0; i < 35; i++) {
                domElements.gameBoard.innerHTML += boardGrid[i] ? boardGrid[i] : '<div></div>';
            }
        }

        function createPlayerPieces() {
            gameState.teams.forEach(team => {
                const piece = document.createElement('div');
                piece.id = `player-${team.id}`;
                piece.className = 'player-piece';
                piece.style.backgroundColor = team.color;
                piece.innerText = team.id + 1;
                domElements.gameBoard.appendChild(piece);
                updatePiecePosition(team.id);
            });
        }
        
        function updatePiecePosition(teamId) {
            const team = gameState.teams[teamId];
            const piece = document.getElementById(`player-${team.id}`);
            const targetSpace = document.getElementById(`space-${team.position}`);
            
            if (targetSpace) {
                const positions = calculatePositions(gameState.teams.length, team.id);
                piece.style.left = `${targetSpace.offsetLeft + positions.x}px`;
                piece.style.top = `${targetSpace.offsetTop + positions.y}px`;
            }
        }
        
        function calculatePositions(total, index) {
            const R = 22; // Radius from center for larger pieces
            const angle = (index / total) * 2 * Math.PI;
            const x = 40 + R * Math.cos(angle);
            const y = 40 + R * Math.sin(angle);
            return {x,y};
        }

        function updateTeamScores() {
            domElements.teamScoresContainer.innerHTML = '';
            gameState.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'flex items-center justify-between p-2 rounded-lg';
                teamDiv.style.backgroundColor = `${team.color}20`;
                teamDiv.innerHTML = `
                    <span class="font-bold" style="color: ${team.color};">${team.name}</span>
                    <span class="text-sm text-gray-700">${team.position} / ${boardSpaces} ì¹¸</span>
                `;
                domElements.teamScoresContainer.appendChild(teamDiv);
            });
        }

        function updateTurnIndicator() {
            const currentTeam = gameState.teams[gameState.currentTurn];
            domElements.turnIndicator.textContent = `${currentTeam.name} ì°¨ë¡€`;
            domElements.turnIndicator.style.backgroundColor = currentTeam.color;
            domElements.rollDiceBtn.disabled = false;
        }

        domElements.rollDiceBtn.addEventListener('click', () => {
            if (!gameState.gameActive) return;
            domElements.rollDiceBtn.disabled = true;

            const diceResult = Math.floor(Math.random() * 6) + 1;
            
            domElements.diceFace.parentElement.classList.add('rolling');
            setTimeout(() => {
                domElements.diceFace.textContent = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][diceResult - 1];
                domElements.diceFace.parentElement.classList.remove('rolling');
                movePlayer(diceResult);
            }, 700);
        });

        function movePlayer(steps) {
            const team = gameState.teams[gameState.currentTurn];
            team.previousPosition = team.position;
            team.position += steps;

            if (team.position >= boardSpaces) {
                team.position = boardSpaces;
                updatePiecePosition(team.id);
                updateTeamScores();
                endGame(team);
                return;
            }

            updatePiecePosition(team.id);
            updateTeamScores();

            setTimeout(() => {
                showMission(team.position - 1);
            }, 500);
        }

        function showMission(missionIndex) {
            const mission = missions[missionIndex];
            if (!mission) {
                nextTurn();
                return;
            }

            domElements.modal.classList.remove('hidden');
            domElements.modalTitle.textContent = `"${mission.type.toUpperCase()}" ë¯¸ì…˜ ì¹´ë“œ`;
            
            let modalBodyHTML = `<p class="mb-4">${mission.content}</p>`;

            if (mission.type === 'ê¸€') {
                modalBodyHTML += `
                    <div class="mt-4 border-t pt-4">
                        <input type="file" id="photo-upload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-2"/>
                        <input type="text" id="photo-caption" placeholder="ì‚¬ì§„ì— ëŒ€í•œ í•œ ë¬¸ì¥ í‘œì–´ë¥¼ ì ì–´ì£¼ì„¸ìš”." class="w-full p-2 border rounded-md">
                        <button id="submit-photo" class="mt-2 bg-emerald-500 text-white py-2 px-4 rounded-md">ì‘í’ˆ ì œì¶œí•˜ê¸°</button>
                        <p class="text-xs text-gray-500 mt-2">ì œì¶œí•œ ì‘í’ˆì€ ê²Œì„ì´ ëë‚˜ê³  í•œë²ˆì— ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.</p>
                    </div>`;
            } else if (mission.type === 'ë§˜') {
                modalBodyHTML += `
                    <div class="mt-4 border-t pt-4">
                        <canvas id="drawing-canvas" width="300" height="200" class="mx-auto bg-white"></canvas>
                         <div class="mt-2">
                             <input type="color" id="color-picker" value="#000000">
                             <button id="clear-canvas" class="text-sm py-1 px-2 border rounded">ì§€ìš°ê¸°</button>
                         </div>
                        <button id="submit-drawing" class="mt-2 bg-orange-500 text-white py-2 px-4 rounded-md">ì‘í’ˆ ì œì¶œí•˜ê¸°</button>
                        <p class="text-xs text-gray-500 mt-2">ì œì¶œí•œ ì‘í’ˆì€ ê²Œì„ì´ ëë‚˜ê³  í•œë²ˆì— ì €ì¥í•  ìˆ˜ ìˆì–´ìš”.</p>
                    </div>`;
            }
            
            domElements.modalBody.innerHTML = modalBodyHTML;
            
            const typeColors = { 'ë§': '#facc15', 'ê¸€': '#34d399', 'ë§˜': '#fb923c' };
            domElements.modalContent.style.borderColor = typeColors[mission.type];

            if (mission.type === 'ê¸€') {
                document.getElementById('submit-photo').onclick = submitPhoto;
            } else if (mission.type === 'ë§˜') {
                setupCanvas();
                document.getElementById('submit-drawing').onclick = submitDrawing;
            }
        }
        
        domElements.closeModalBtn.addEventListener('click', () => {
            domElements.modal.classList.add('hidden');
            nextTurn();
        });
        
        domElements.failMissionBtn.addEventListener('click', () => {
            const team = gameState.teams[gameState.currentTurn];
            team.position = team.previousPosition;
            updatePiecePosition(team.id);
            updateTeamScores();
            alert(`${team.name}ì´/ê°€ ë¯¸ì…˜ì„ í•´ê²°í•˜ì§€ ëª»í•´ ì›ë˜ ìë¦¬ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.`);
            domElements.modal.classList.add('hidden');
            nextTurn();
        });

        function nextTurn() {
            gameState.currentTurn = (gameState.currentTurn + 1) % gameState.teams.length;
            updateTurnIndicator();
        }

        function submitPhoto() {
            const photoInput = document.getElementById('photo-upload');
            const captionInput = document.getElementById('photo-caption');
            if (photoInput.files.length > 0 && captionInput.value) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addGalleryItem('ê¸€', { src: e.target.result, caption: captionInput.value });
                }
                reader.readAsDataURL(photoInput.files[0]);
                alert('ì‘í’ˆì´ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                alert('ì‚¬ì§„ê³¼ í‘œì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function submitDrawing() {
            const canvas = document.getElementById('drawing-canvas');
            const dataUrl = canvas.toDataURL('image/png');
            addGalleryItem('ë§˜', { src: dataUrl, caption: "ìš°ë¦¬ì˜ ë§ˆìŒ ì´ëª¨í‹°ì½˜" });
            alert('ì‘í’ˆì´ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        function addGalleryItem(type, data) {
            // This visual element is no longer the primary storage
            const item = document.createElement('div');
            item.dataset.src = data.src;
            item.dataset.caption = data.caption;
            item.dataset.type = type;
            domElements.gallery.appendChild(item);

            // NEW: Save to sessionStorage for persistence during the session
            const galleryItems = JSON.parse(sessionStorage.getItem('galleryItems')) || [];
            galleryItems.push({ type, src: data.src, caption: data.caption });
            sessionStorage.setItem('galleryItems', JSON.stringify(galleryItems));
        }

        function setupCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            const ctx = canvas.getContext('2d');
            let drawing = false;
            
            const colorPicker = document.getElementById('color-picker');
            const clearBtn = document.getElementById('clear-canvas');

            const getPos = (evt, isTouch = false) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
                const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDrawing = (e) => {
                drawing = true;
                const pos = getPos(e, e.type === 'touchstart');
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
                if (e.type === 'touchstart') e.preventDefault();
            };
            const stopDrawing = (e) => {
                drawing = false;
                if (e.type === 'touchend') e.preventDefault();
            };
            const draw = (e) => {
                if (!drawing) return;
                const pos = getPos(e, e.type === 'touchmove');
                ctx.lineWidth = 3; ctx.lineCap = 'round';
                ctx.strokeStyle = colorPicker.value;
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
                if (e.type === 'touchmove') e.preventDefault();
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', draw);
            
            clearBtn.onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function endGame(winner) {
            gameState.gameActive = false;
            domElements.finalSlideshow.innerHTML = '';
            
            // NEW: Load items from sessionStorage to build the final slideshow
            const galleryItems = JSON.parse(sessionStorage.getItem('galleryItems')) || [];

            galleryItems.forEach((item, index) => {
                const slideItem = document.createElement('div');
                slideItem.className = 'relative group';
                const fileType = item.type === 'ë§˜' ? 'png' : 'jpg';

                slideItem.innerHTML = `
                    <img src="${item.src}" class="w-full h-32 object-cover rounded-md">
                    <a href="${item.src}" download="ë§ê¸€ë§˜_ì‘í’ˆ_${index + 1}.${fileType}" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity rounded-md">
                        ì €ì¥í•˜ê¸°
                    </a>
                `;
                domElements.finalSlideshow.appendChild(slideItem);
            });
            
            setTimeout(() => {
                domElements.finalModal.classList.remove('hidden');
            }, 1000);
        }
    </script>
</body>
</html>

